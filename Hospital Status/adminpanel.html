<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Status Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        
        <!-- Header Section -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 bg-white p-4 rounded-lg shadow">
            <div class="flex items-center">
                 <svg class="w-10 h-10 text-blue-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0012 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75z" />
                </svg>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-700">Hospital Status Admin Panel</h1>
            </div>
            <div id="clock" class="text-lg font-semibold text-gray-600 bg-gray-100 px-4 py-2 rounded-md mt-4 md:mt-0">
                Loading time...
            </div>
        </header>

        <!-- Add Hospital Form -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <h2 class="text-xl font-bold mb-3">Add New Hospital</h2>
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="text" id="new-hospital-name" placeholder="Hospital Name" class="flex-grow p-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <button id="add-hospital-btn" class="btn bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Add Hospital</button>
            </div>
        </div>


        <!-- Main Status Board List -->
        <main id="status-board" class="flex flex-col gap-2">
            <div class="text-center p-10 bg-white rounded-lg shadow">
                <p class="text-gray-500">Connecting to live data...</p>
            </div>
        </main>
        
    </div>
    
    <script type="module">
        // --- FIREBASE SDK IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, getDocs, writeBatch, setDoc, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- FIREBASE CONFIG & INITIALIZATION ---

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-hospital-board';
        const firebaseConfig = {
  apiKey: "AIzaSyCU0IdmKT-9v8MeyhGrE61qxDHGSceWM9k",
  authDomain: "gmv-hospital-status.firebaseapp.com",
  projectId: "gmv-hospital-status",
  storageBucket: "gmv-hospital-status.firebasestorage.app",
  messagingSenderId: "435969463148",
  appId: "1:435969463148:web:fcc5b6a24ca9c8d65ad949",
  measurementId: "G-4LW53X096P"
};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const hospitalsColPath = `/artifacts/${appId}/public/data/hospitals`;
        const hospitalsCollection = collection(db, hospitalsColPath);
        
        // --- DATA SEEDING (RUNS ONCE IF DB IS EMPTY) ---
        const seedInitialData = async () => {
            const snapshot = await getDocs(hospitalsCollection);
            if (snapshot.empty) {
                console.log("No data found. Seeding initial hospital statuses...");
                const batch = writeBatch(db);
                const initialHospitals = [
                    { name: 'Springfield General', isOnDiversion: false, notes: 'Accepting all transfers.' },
                    { name: 'Mercy Hospital', isOnDiversion: true, notes: 'ER at capacity. Only accepting trauma.' },
                    { name: 'Shelbyville Hospital', isOnDiversion: false, notes: 'Pediatrics full.' },
                    { name: 'Capital City Medical', isOnDiversion: false, notes: '' },
                    { name: 'Ogdenville Medical Center', isOnDiversion: false, notes: 'MRI is down.' },
                    { name: 'North Haverbrook Clinic', isOnDiversion: true, notes: 'No neurologists on site.' },
                ];
                initialHospitals.forEach(hospital => {
                    const docRef = doc(hospitalsCollection); // Auto-generate ID
                    batch.set(docRef, hospital);
                });
                await batch.commit();
                console.log("Initial data seeded.");
            }
        };

        // --- DOM MANIPULATION ---
        const renderBoard = (hospitals) => {
            const board = document.getElementById('status-board');
            board.innerHTML = '';
            
            if (!hospitals || hospitals.length === 0) {
                 board.innerHTML = `<div class="text-center p-10 bg-white rounded-b-lg shadow"><p class="text-gray-500">No hospital data available. Add one above to get started.</p></div>`;
                 return;
            }
            
            hospitals.sort((a, b) => a.name.localeCompare(b.name));

            hospitals.forEach(hospital => {
                const diversionClass = hospital.isOnDiversion ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
                const diversionText = hospital.isOnDiversion ? 'On Diversion' : 'Accepting';
                const buttonToggleClass = hospital.isOnDiversion ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600';
                const buttonToggleText = hospital.isOnDiversion ? 'Set Accepting' : 'Set Diversion';

                const listItem = `
                    <div id="${hospital.id}" class="bg-white rounded-lg shadow-md p-4 flex flex-col gap-4 transition-all duration-300">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                             <h2 class="text-lg font-bold text-gray-800">${hospital.name}</h2>
                             <div class="font-bold p-2 rounded-md ${diversionClass} text-center mt-2 sm:mt-0 text-sm">
                                ${diversionText}
                            </div>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-2">
                             <input type="text" id="notes-input-${hospital.id}" value="${hospital.notes || ''}" class="flex-grow p-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Enter notes...">
                             <button onclick="window.updateNotes('${hospital.id}')" class="btn bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-gray-700">Save Notes</button>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-2 justify-end mt-2">
                            <button onclick="window.toggleStatus('${hospital.id}', ${hospital.isOnDiversion})" class="btn text-white font-bold py-2 px-4 rounded-lg shadow ${buttonToggleClass}">
                                ${buttonToggleText}
                            </button>
                            <button onclick="window.deleteHospital('${hospital.id}')" class="btn bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-red-500 hover:text-white">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
                board.innerHTML += listItem;
            });
        };

        // --- LIVE UPDATES ---
        window.toggleStatus = async (id, currentStatus) => {
            const hospitalDoc = doc(db, hospitalsColPath, id);
            try {
                await updateDoc(hospitalDoc, { isOnDiversion: !currentStatus });
            } catch (error) { console.error("Error updating status: ", error); }
        };

        window.updateNotes = async (id) => {
            const input = document.getElementById(`notes-input-${id}`);
            const hospitalDoc = doc(db, hospitalsColPath, id);
            try {
                await updateDoc(hospitalDoc, { notes: input.value });
                input.classList.add('border-green-500', 'ring-green-300');
                setTimeout(() => input.classList.remove('border-green-500', 'ring-green-300'), 2000);
            } catch (error) { console.error("Error updating notes: ", error); }
        };
        
        window.deleteHospital = async (id) => {
             if (confirm('Are you sure you want to delete this hospital?')) {
                const hospitalDoc = doc(db, hospitalsColPath, id);
                try {
                    await deleteDoc(hospitalDoc);
                } catch (error) { console.error("Error deleting hospital: ", error); }
            }
        };
        
        const addHospital = async () => {
            const input = document.getElementById('new-hospital-name');
            const hospitalName = input.value.trim();
            if (hospitalName) {
                try {
                    await addDoc(hospitalsCollection, {
                        name: hospitalName,
                        isOnDiversion: false,
                        notes: 'Newly added.'
                    });
                    input.value = ''; // Clear input on success
                } catch (error) { console.error("Error adding hospital: ", error); }
            }
        };

        const updateClock = () => {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            document.getElementById('clock').textContent = now.toLocaleDateString('en-US', options);
        };
        
        // --- INITIALIZATION ---
        const main = async () => {
            if (typeof __initial_auth_token !== 'undefined') {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
            
            await seedInitialData();

            onSnapshot(hospitalsCollection, (snapshot) => {
                const hospitals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderBoard(hospitals);
            }, (error) => {
                console.error("Error fetching live data: ", error);
                document.getElementById('status-board').innerHTML = `<div class="text-center p-10 bg-white rounded-b-lg shadow"><p class="text-red-500">Error connecting to live data. Please refresh.</p></div>`;
            });

            document.getElementById('add-hospital-btn').addEventListener('click', addHospital);
            updateClock();
            setInterval(updateClock, 1000 * 60); // Update clock every minute
        };

        main();

    </script>
</body>
</html>




